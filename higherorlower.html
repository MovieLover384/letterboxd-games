<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Higher or Lower: Films This Year</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="higherorlower.css">
</head>
<body class="flex flex-col min-h-screen">

<header class="bg-film-surface/80 backdrop-blur-md border-b border-gray-800 sticky top-0 z-50">
  <div class="container mx-auto px-4 py-4 flex items-center justify-between">
    <a href="/letterboxd-game/" class="flex items-center gap-2">
      <div class="w-9 h-9 rounded-lg bg-orange-500 flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-5 h-5 text-white">
          <path d="M3 3h18v18H3V3zm2 2v14h14V5H5z"/>
        </svg>
      </div>
      <span class="text-xl font-serif font-bold">
        Letterboxd <span class="text-gradient-accent">Games</span>
      </span>
    </a>
    <nav class="flex items-center gap-6">
      <a href="/letterboxd-game/" class="hover:text-white transition">Home</a>
      <a href="/letterboxd-game/info" class="hover:text-white transition">Info</a>
    </nav>
  </div>
</header>

<section class="relative text-center py-24 md:py-32 bg-gradient-to-br from-gray-900 via-gray-800 to-green-900 overflow-hidden">
  <div class="relative z-10 max-w-3xl mx-auto px-4">
    <h1 class="text-5xl md:text-6xl font-bold mb-4">Higher or Lower: Films This Year</h1>
    <p class="text-lg md:text-xl text-gray-400">Guess if the right user watched more or fewer films this year than the left user.</p>
  </div>
</section>

<section class="container mx-auto px-4 py-12 flex-1 text-center">
  <div id="score" class="text-lg font-semibold mb-6">Score: 0</div>
  <div id="users">
    <div id="leftUser" class="user-card"></div>
    <div id="rightUser" class="user-card"></div>
  </div>

  <div id="buttons" class="flex justify-center gap-6 my-6">
    <button id="higherBtn" class="bg-orange-500 hover:bg-orange-600 text-black px-6 py-3 font-semibold rounded-lg text-lg transition">Higher</button>
    <button id="lowerBtn" class="bg-orange-500 hover:bg-orange-600 text-black px-6 py-3 font-semibold rounded-lg text-lg transition">Lower</button>
  </div>

  <div id="result" class="text-lg font-semibold mb-6"></div>

  <div id="nextBtnContainer" class="mb-6 hidden">
    <button id="nextUsersBtn" class="bg-green-500 hover:bg-green-600 text-black px-6 py-3 font-semibold rounded-lg text-lg transition">Next Round</button>
  </div>

  <div class="h-24"></div>
</section>

<footer class="bg-film-surface border-t border-gray-800 py-12 text-center mt-auto">
  <h3 class="text-orange-500 mb-2">
    Letterboxd Games ~ Fan project, Not affiliated with Letterboxd
  </h3>
  <p class="text-gray-400 mb-1 flex items-center justify-center gap-2">
    Made with
    <svg width="18" height="18" viewBox="0 0 24 24" class="inline-block">
      <defs>
        <linearGradient id="heartGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="hsl(25,95%,55%)"/>
          <stop offset="100%" stop-color="hsl(35,90%,60%)"/>
        </linearGradient>
      </defs>
      <path
        d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 
           2 6 4 4 6.5 4 
           8.24 4 9.91 5.01 10.44 6.36 
           10.97 5.01 12.64 4 14.38 4 
           16.88 4 18.88 6 18.88 8.5 
           18.88 12.28 15.48 15.36 10.33 20.04L12 21.35z"
        fill="url(#heartGradient)"
      />
    </svg>
    for film lovers
  </p>
  <p class="text-gray-400">
    Follow me on 
    <a href="https://letterboxd.com/MovieLover384/" target="_blank" class="text-orange-500 hover:text-orange-400 underline">
      Letterboxd
    </a>
  </p>
</footer>

<script>
let members = [];
let favorites = [];
let leftUser = null;
let rightUser = null;
let score = 0;

async function loadData() {
    members = await fetch('members.json').then(res => res.json());
    favorites = await fetch('4fav.json').then(res => res.json());

    // Filter out members without 'this_year' stat
    members = members.filter(member => member.stats && typeof member.stats.this_year === 'number');

    startNewRound();
}

function getFavorites(username) {
    const userFav = favorites.find(f => f.username === username);
    return (userFav?.favorites || []).slice(0,4);
}

function startNewRound() {
    document.getElementById('nextBtnContainer').classList.add('hidden');
    document.getElementById('result').innerText = "";
    document.getElementById('higherBtn').disabled = false;
    document.getElementById('lowerBtn').disabled = false;
    if (!leftUser) leftUser = members[Math.floor(Math.random() * members.length)];
    do {
        rightUser = members[Math.floor(Math.random() * members.length)];
    } while (rightUser.username === leftUser.username);
    displayUsers();
}

function displayUsers() {
    const leftDiv = document.getElementById('leftUser');
    const rightDiv = document.getElementById('rightUser');
    const leftFavs = getFavorites(leftUser.username);
    const rightFavs = getFavorites(rightUser.username);

    function buildFavs(favs) {
        return favs.map(f => `
            <div class="relative group">
                <img src="${f.poster_url}" alt="${f.title}" class="favorite-movie-poster rounded-lg">
                <div class="absolute inset-0 bg-black bg-opacity-70 text-white flex items-center justify-center opacity-0 group-hover:opacity-100 rounded-lg text-center text-sm p-1 transition-opacity">
                    ${f.title}
                </div>
            </div>
        `).join('');
    }

    leftDiv.innerHTML = `
        <img src="${leftUser.avatar_url}" class="profile-pic">
        <h3 class="text-xl font-bold">${leftUser.username}</h3>
        <p>Total films: ${leftUser.stats.films}</p>
        <p>Films this year: ${leftUser.stats.this_year}</p>
        <div class="favorite-movies">
            ${buildFavs(leftFavs)}
        </div>
    `;

    rightDiv.innerHTML = `
        <img src="${rightUser.avatar_url}" class="profile-pic">
        <h3 class="text-xl font-bold">${rightUser.username}</h3>
        <p>Total films: ${rightUser.stats.films}</p>
        <p>Films this year: ???</p>
        <div class="favorite-movies">
            ${buildFavs(rightFavs)}
        </div>
    `;

    leftDiv.classList.remove('slide');
    rightDiv.classList.remove('slide');
}

function slideRightToLeft() {
    const leftDiv = document.getElementById('leftUser');
    const rightDiv = document.getElementById('rightUser');
    leftDiv.style.transition = 'transform 0.7s ease, opacity 0.7s ease';
    leftDiv.style.transform = 'translateX(-120%)';
    leftDiv.style.opacity = '0';
    rightDiv.style.transition = 'transform 0.7s ease';
    rightDiv.style.transform = 'translateX(-100%)';
    setTimeout(() => {
        leftUser = rightUser;
        leftDiv.style.transition = '';
        leftDiv.style.transform = '';
        leftDiv.style.opacity = '';
        rightDiv.style.transition = '';
        rightDiv.style.transform = '';
        let newRightUser;
        do {
            newRightUser = members[Math.floor(Math.random() * members.length)];
        } while (newRightUser.username === leftUser.username);
        rightUser = newRightUser;
        displayUsers();
        document.getElementById('higherBtn').disabled = false;
        document.getElementById('lowerBtn').disabled = false;
    }, 700);
}

function makeGuess(higher) {
    document.getElementById('higherBtn').disabled = true;
    document.getElementById('lowerBtn').disabled = true;
    const resultDiv = document.getElementById('result');
    const actualHigher = rightUser.stats.this_year >= leftUser.stats.this_year;
    if ((higher && actualHigher) || (!higher && !actualHigher)) {
        score++;
        document.getElementById('score').innerText = `Score: ${score}`;
        resultDiv.innerText = `Correct! ${rightUser.username} watched ${rightUser.stats.this_year} this year.`;
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        slideRightToLeft();
    } else {
        score = 0;
        document.getElementById('score').innerText = `Score: ${score}`;
        resultDiv.innerText = `Wrong! ${rightUser.username} watched ${rightUser.stats.this_year} this year.`;
        document.getElementById('nextBtnContainer').classList.remove('hidden');
    }
}

document.getElementById('higherBtn').addEventListener('click',()=>makeGuess(true));
document.getElementById('lowerBtn').addEventListener('click',()=>makeGuess(false));
document.getElementById('nextUsersBtn').addEventListener('click',()=>{
    leftUser = rightUser;
    startNewRound();
});

loadData();
</script>
</body>
</html>
